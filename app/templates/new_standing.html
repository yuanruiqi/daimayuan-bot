<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>成绩排名表（流式）</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="{{ url_for('static', filename='css/standing.css') }}" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
<script src="https://unpkg.com/tablesort/dist/sorts/tablesort.number.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chroma-js@2.4.2/chroma.min.js"></script>
</head>
<body>
<div class="main-container">
  <div class="content-wrapper">
    <div class="decor-element decor-circle"></div>
    <div class="decor-element decor-blob"></div>
    <div class="header">
      <div class="header d-flex justify-content-between align-items-center my-4">
        <h1 class="mx-auto">成绩排名表（流式）</h1>
        <form action="/retry" method="post">
          <input type="hidden" name="start_id" value="{{startid}}">
          <input type="hidden" name="end_id" value="{{endid}}">
          <input type="hidden" name="cid" value="{{cid}}">
        </form>
      </div>
    </div>
    <div class="card">
      <div class="controls">
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="搜索用户名...">
        </div>
        <div class="fullscreen-controls">
          <button id="toggleFullscreen" class="fullscreen-btn" title="全屏显示">
            ↗
          </button>
          <button id="exitFullscreen" class="fullscreen-btn" title="退出全屏">
            ✕
          </button>
        </div>
      </div>
    </div>
    <div class="card timeline-container">
      <div class="timeline-controls">
        <button id="prevSnapshot" class="timeline-btn" title="上一个时刻">◀</button>
        <div class="timeline-slider-container" style="position:relative;">
          <input type="range" id="timelineSlider" class="timeline-slider" min="0" max="100" value="100">
          <div class="timeline-marks">
            <span id="timelineStart" style="position:absolute;left:0;top:18px;font-size:12px;cursor:pointer;color:#007bff;">起点</span>
            <span id="timelineEnd" style="position:absolute;right:0;top:18px;font-size:12px;cursor:pointer;color:#007bff;">终点</span>
            <span id="timelineCurrent" style="position:absolute;left:50%;top:18px;font-size:12px;transform:translateX(-50%);color:#333;">当前提交: --</span>
          </div>
        </div>
        <button id="nextSnapshot" class="timeline-btn" title="下一个时刻">▶</button>
      </div>
    </div>
    <div class="card table-card">
      <div id="stream-table-container">
        <!-- 流式表格内容将由 JS 动态填充 -->
      </div>
    </div>
    <div class="card chart-card">
      <canvas id="scoreChart"></canvas>
    </div>
  </div>
</div>
<script src="{{ url_for('static', filename='js/standing.js') }}"></script>
<script src="{{ url_for('static', filename='js/standing-anim.js') }}"></script>
<script>
// 记录上一次分数快照和排名快照
let lastScoreSnapshot = {};
let lastRankSnapshot = [];
function getCurrentRankSnapshot() {
  return Array.from(document.querySelectorAll('#rank-table tbody tr')).map(row => row.querySelector('.username-cell').textContent);
}
// 包装表格渲染函数，添加分数和排名动画
const origRenderTableBySnapshot = window.renderTableBySnapshot;
window.renderTableBySnapshot = function(idx) {
  origRenderTableBySnapshot(idx);
  // 分数动画（只对变化的）
  setTimeout(() => {
    let curScoreSnapshot = {};
    document.querySelectorAll('#rank-table tbody tr').forEach(row => {
      const user = row.querySelector('.username-cell').textContent;
      curScoreSnapshot[user] = [];
      row.querySelectorAll('.score-cell .score-text').forEach((span, idx) => {
        curScoreSnapshot[user][idx] = span.textContent;
      });
    });
    document.querySelectorAll('#rank-table tbody tr').forEach(row => {
      const user = row.querySelector('.username-cell').textContent;
      row.querySelectorAll('.score-cell .score-text').forEach((span, idx) => {
        if (!lastScoreSnapshot[user] || lastScoreSnapshot[user][idx] !== span.textContent) {
          span.classList.remove('score-change');
          void span.offsetWidth;
          span.classList.add('score-change');
        }
      });
    });
    lastScoreSnapshot = curScoreSnapshot;
    // 整行排名动画
    if (window.standingAnim && window.standingAnim.triggerAnimationOnce) {
      const oldOrder = lastRankSnapshot.length ? lastRankSnapshot : getCurrentRankSnapshot();
      const rows = Array.from(document.querySelectorAll('#rank-table tbody tr'));
      const oldPositions = new Map();
      oldOrder.forEach((username, i) => oldPositions.set(username, i));
      rows.forEach((row, newIdx) => {
        const username = row.querySelector('.username-cell').textContent;
        const oldIdx = oldPositions.get(username);
        if (oldIdx !== undefined && oldIdx !== newIdx) {
          const dist = (oldIdx - newIdx) * row.offsetHeight;
          row.style.setProperty('--move-distance', `${dist}px`);
          const className = oldIdx > newIdx ? 'rank-up' : 'rank-down';
          window.standingAnim.triggerAnimationOnce(row, className);
        }
      });
      lastRankSnapshot = getCurrentRankSnapshot();
    }
  }, 30);
};
// 修正表头和分数颜色
function fixTableHeaderAndColor() {
  // 修正表头（如有需要可自定义）
  const table = document.getElementById('rank-table');
  if (table) {
    // 例如：将表头内容全部转为中文（如有需要可自定义映射）
    const ths = table.querySelectorAll('thead th');
    ths.forEach((th, idx) => {
      // 这里可以自定义表头映射
      if (th.textContent === '用户名') th.textContent = '用户名';
      if (th.textContent.match(/^\d+$/)) th.textContent = '题目' + th.textContent;
      if (th.textContent === '总分') th.textContent = '总分';
    });
  }
}
// 监听 SSE 数据渲染后修正
eventSource.onmessage = function(e) {
  if (typeof origEventSource === 'function') origEventSource.call(this, e);
  setTimeout(fixTableHeaderAndColor, 100); // 等待表格渲染后修正
};
// 页面初次加载也修正一次
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', fixTableHeaderAndColor);
} else {
  fixTableHeaderAndColor();
}
</script>
<script>
let timelineData = [];
let tableHeader = [];
let users = [];
let problems = [];
let problemMap = {};

function renderTableBySnapshot(idx) {
  if (!timelineData.length || !users.length || !tableHeader.length) return;
  // 1. 计算当前快照所有用户每题分数
  const snapshot = timelineData[idx];
  // 构建分数字典：user -> problem -> score
  const userScores = {};
  users.forEach(u => { userScores[u] = {}; problems.forEach(p => { userScores[u][p] = 0; }); });
  // 累加到当前快照
  for (let i = 0; i <= idx; ++i) {
    const snap = timelineData[i];
    if (userScores[snap.username] && userScores[snap.username][snap.problemId] !== undefined) {
      userScores[snap.username][snap.problemId] = snap.score;
    }
  }
  // 2. 计算总分并排序
  const userTotal = users.map(u => {
    let total = 0;
    problems.forEach(p => { total += userScores[u][p]; });
    return { user: u, total, scores: problems.map(p => userScores[u][p]) };
  });
  userTotal.sort((a, b) => b.total - a.total);
  // 3. 渲染表格（修正表头和列顺序）
  let html = '<table id="rank-table" class="table table-hover"><thead><tr>';
  html += '<th>排名</th><th>用户名</th>';
  problems.forEach(p => {
    if (problemMap && problemMap[p]) {
      html += `<th>${p}：${problemMap[p]}</th>`;
    } else {
      html += `<th>${p}</th>`;
    }
  });
  html += '<th>总分</th></tr></thead><tbody>';
  userTotal.forEach((row, i) => {
    html += `<tr><td class="rank-cell">${i+1}</td><td class="username-cell">${row.user}</td>`;
    row.scores.forEach((s, j) => {
      // 拼接提交历史
      let historyHtml = '';
      if (window.submission_history && window.submission_history[row.user] && window.submission_history[row.user][problems[j]]) {
        const historyArr = window.submission_history[row.user][problems[j]];
        if (historyArr.length > 0) {
          historyHtml = '<div class="submission-history">' + historyArr.map(item =>
            `<div class=\"history-item\"><a href=\"http://oj.daimayuan.top/submission/${item[0]}\" class=\"submission-link\" target=\"_blank\">#${item[0]}</a><span class=\"score\">${item[1]}</span></div>`
          ).join('') + '</div>';
        }
      }
      html += `<td class=\"score-cell\"><span class=\"score-text\">${s}</span>${historyHtml}</td>`;
    });
    html += `<td class=\"score-cell\"><span class=\"score-text\">${row.total}</span></td></tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('stream-table-container').innerHTML = html;
  colorScoreCellsForNewStanding();
}

function updateTimelineBySlider(val) {
  if (!timelineData.length) return;
  const idx = Math.round((val / 100) * (timelineData.length - 1));
  const data = timelineData[idx];
  // 动态显示当前提交编号
  const cur = document.getElementById('timelineCurrent');
  if (cur && data && data.submissionId !== undefined) {
    cur.textContent = '当前提交: #' + data.submissionId;
  } else if (cur) {
    cur.textContent = '当前提交: --';
  }
  renderTableBySnapshot(idx);
}

// timeline 滑块和左右按钮事件绑定
function bindTimelineEvents() {
  const slider = document.getElementById('timelineSlider');
  const prevBtn = document.getElementById('prevSnapshot');
  const nextBtn = document.getElementById('nextSnapshot');
  if (!slider || !timelineData.length) return;
  let currentIdx = timelineData.length - 1;
  slider.addEventListener('input', function() {
    currentIdx = Math.round((this.value / 100) * (timelineData.length - 1));
    updateTimelineBySlider(this.value);
  });
  prevBtn && prevBtn.addEventListener('click', function() {
    if (currentIdx > 0) {
      currentIdx--;
      slider.value = (currentIdx / (timelineData.length - 1)) * 100;
      updateTimelineBySlider(slider.value);
    }
  });
  nextBtn && nextBtn.addEventListener('click', function() {
    if (currentIdx < timelineData.length - 1) {
      currentIdx++;
      slider.value = (currentIdx / (timelineData.length - 1)) * 100;
      updateTimelineBySlider(slider.value);
    }
  });
}

window.eventSource = new EventSource(`/standing/stream/{{ task_id }}`);
window.eventSource.onmessage = function(e) {
  const data = JSON.parse(e.data);
  timelineData = data.timeline_data || [];
  tableHeader = data.table_header || [];
  users = data.users || [];
  problems = data.problems || [];
  problemMap = data.problem_map || {};
  window.submission_history = data.submission_history || {};
  if (data.error) {
    document.getElementById('stream-table-container').innerHTML = `<div>${data.error}</div>`;
    return;
  }
  // 每次收到数据都刷新表格并触发动画
  if (timelineData.length) {
    document.getElementById('timelineSlider').value = 100;
    // 先渲染表格
    updateTimelineBySlider(100);
    // 触发动画：对所有分数单元格添加 score-change 动画类
    setTimeout(() => {
      document.querySelectorAll('#rank-table .score-cell .score-text').forEach(span => {
        span.classList.remove('score-change');
        // 强制重绘
        void span.offsetWidth;
        span.classList.add('score-change');
      });
      // 新增：对所有排名单元格触发排名动画
      if (window.standingAnim && window.standingAnim.applyRankAnimation) {
        const rows = Array.from(document.querySelectorAll('#rank-table tbody tr'));
        const oldPositions = new Map();
        rows.forEach((r, i) => oldPositions.set(r.querySelector('.username-cell').textContent, i));
        // 以当前顺序为 oldPositions，下一次渲染后再触发动画
        setTimeout(() => {
          const newRows = Array.from(document.querySelectorAll('#rank-table tbody tr'));
          window.standingAnim.applyRankAnimation(newRows, oldPositions, newRows);
        }, 10);
      }
    }, 50);
    bindTimelineEvents();
  }
};
window.eventSource.onerror = function() {
  window.eventSource.close();
};
// 独立提取分数颜色渲染函数，供本页面表格渲染后调用，不影响 standing.html
function colorScoreCellsForNewStanding() {
  if (typeof chroma === 'undefined') return;
  const colorScale = chroma.scale(['#e74c3c', '#f39c12', '#27ae60']).domain([0, 50, 100]);
  document.querySelectorAll('#rank-table tbody td.score-cell').forEach(cell => {
    let scoreSpan = cell.querySelector('.score-text');
    if (!scoreSpan) return;
    const score = parseFloat(scoreSpan.textContent);
    const isTotalScore = cell.cellIndex === cell.parentElement.cells.length - 1;
    const maxScore = isTotalScore ? 300 : 100;
    if (score < 0) {
      scoreSpan.style.color = '#95a5a5';
    } else {
      let percent = Math.max(0, Math.min(1, score / maxScore));
      scoreSpan.style.color = colorScale(percent * 100).hex();
      scoreSpan.style.background = '';
      scoreSpan.style.backgroundClip = '';
      scoreSpan.style.webkitBackgroundClip = '';
    }
  });
}
// 在 renderTableBySnapshot 渲染后调用
renderTableBySnapshot = function(idx) {
  origRenderTableBySnapshot(idx);
  colorScoreCellsForNewStanding();
};
document.getElementById('timelineSlider').addEventListener('input', function() {
  updateTimelineBySlider(this.value);
});
</script>
<style>
@keyframes scoreChange {
  0% { background-color: transparent; }
  10%   { transform: scale(1.2); background-color: transparent; }
  100% { background-color: transparent; }
}
.score-change {
  display: inline-block;
  animation: scoreChange 0.45s ease-out;
}
</style>
</body>
</html>
